# Examples of x64 Code Generated by native-image


## Disassembling hello-graal

First, set up your native-image environment by following this demo:

- Start with [hello-graal demo](https://github.com/graalvm/graalvm-demos/tree/master/hello-graal)
- Follow the instructions to build and execute the `Hello` binary from [src/com/hello/Graal.java](https://github.com/graalvm/graalvm-demos/blob/master/hello-graal/src/com/hello/Graal.java)
- Read this page about [generating debug info with native-image](https://www.graalvm.org/22.0/reference-manual/native-image/DebugInfo/)

Now, rebuild the program with `-g`:

```
$ native-image -g -jar Hello.jar
WARNING: Unknown module: org.graalvm.nativeimage.llvm specified to --add-exports
WARNING: Unknown module: org.graalvm.nativeimage.llvm specified to --add-exports
WARNING: Unknown module: org.graalvm.nativeimage.llvm specified to --add-exports
========================================================================================================================
GraalVM Native Image: Generating 'Hello' (executable)...
========================================================================================================================
[1/7] Initializing...                                                                                    (2.2s @ 0.12GB)
 Version info: 'GraalVM 22.2.0 Java 17 CE'
 Java version info: '17.0.4+8-jvmci-22.2-b06'
 C compiler: gcc (linux, x86_64, 11.2.0)
 Garbage collector: Serial GC
[2/7] Performing analysis...  [*****]                                                                    (4.9s @ 0.46GB)
   2,831 (73.49%) of  3,852 classes reachable
   3,416 (51.15%) of  6,678 fields reachable
  12,743 (43.77%) of 29,111 methods reachable
      28 classes,     0 fields, and   319 methods registered for reflection
      58 classes,    58 fields, and    52 methods registered for JNI access
       4 native libraries: dl, pthread, rt, z
[3/7] Building universe...                                                                               (0.8s @ 0.92GB)
[4/7] Parsing methods...      [*]                                                                        (0.6s @ 1.64GB)
[5/7] Inlining methods...     [***]                                                                      (0.4s @ 0.65GB)
[6/7] Compiling methods...    [**]                                                                       (3.6s @ 1.74GB)
[7/7] Creating image...                                                                                  (3.6s @ 1.67GB)
   4.33MB (23.88%) for code area:     7,472 compilation units
   6.96MB (38.39%) for image heap:   96,044 objects and 5 resources
   7.74MB (42.69%) for debug info generated in 2.0s
-943095.00B (-4.96%) for other data
  18.13MB in total
------------------------------------------------------------------------------------------------------------------------
Top 10 packages in code area:                               Top 10 object types in image heap:
 664.09KB java.util                                          937.61KB byte[] for code metadata
 339.50KB java.lang                                          892.88KB java.lang.String
 273.76KB java.text                                          834.35KB byte[] for general heap data
 234.86KB java.util.regex                                    641.69KB java.lang.Class
 198.40KB com.oracle.svm.jni                                 541.40KB byte[] for java.lang.String
 193.88KB java.util.concurrent                               434.86KB java.util.HashMap$Node
 146.93KB java.math                                          221.17KB com.oracle.svm.core.hub.DynamicHubCompanion
 121.43KB java.lang.invoke                                   209.58KB java.util.HashMap$Node[]
 105.90KB com.oracle.svm.core.genscavenge                    163.52KB java.lang.String[]
  98.16KB java.util.logging                                  155.81KB java.util.concurrent.ConcurrentHashMap$Node
   1.95MB for 119 more packages                                1.53MB for 772 more object types
------------------------------------------------------------------------------------------------------------------------
                        0.4s (2.3% of total time) in 18 GCs | Peak RSS: 3.88GB | CPU load: 9.36
------------------------------------------------------------------------------------------------------------------------
Produced artifacts:
 /jdk3/ni/graalvm-demos/hello-graal/Hello (executable, debug_info)
 /jdk3/ni/graalvm-demos/hello-graal/Hello.build_artifacts.txt (txt)
 /jdk3/ni/graalvm-demos/hello-graal/sources (debug_info)
========================================================================================================================
Finished generating 'Hello' in 17.3s.
```

The binary generated with `native-image -g` can be examined with gdb:

```
$ gdb Hello
(gdb) b main
Breakpoint 1 at 0x4f000: main. (2 locations)
(gdb) r
Breakpoint 1, com.oracle.svm.core.code.IsolateEnterStub::JavaMainWrapper_run_5087f5482cc9a6abc971913ece43acb471d2631b(int, org.graalvm.nativeimage.c.type.CCharPointerPointer *) (__0=1, __1=0x7fffffffcec8) at com/oracle/svm/core/code/IsolateEnterStub.java:1
1	com/oracle/svm/core/code/IsolateEnterStub.java: No such file or directory.

(gdb) info func ::main
All functions matching regular expression "::main":

File com/hello/Graal.java:
   void com.hello.Graal::main(java.lang.String[] *);
(gdb) disass 'com.hello.Graal::main'
Dump of assembler code for function com.hello.Graal::main(java.lang.String[] *):
   0x00005555555a3000 <+0>:    sub    $0x8,%rsp
   0x00005555555a3004 <+4>:    cmp    0x8(%r15),%rsp
   0x00005555555a3008 <+8>:    jbe    0x5555555a3048 <com.hello.Graal::main(java.lang.String[] *)+72>
   0x00005555555a300e <+14>:   movabs $0x559e30,%rdi
   0x00005555555a3018 <+24>:   lea    (%r14,%rdi,1),%rdi
   0x00005555555a301c <+28>:   movabs $0x288c98,%rsi
   0x00005555555a3026 <+38>:   lea    (%r14,%rsi,1),%rsi
   0x00005555555a302a <+42>:   call   0x55555569fe50 <java.io.PrintStream::writeln(java.lang.String *)>
   0x00005555555a302f <+47>:   nop
   0x00005555555a3030 <+48>:   subl   $0x1,0x10(%r15)
   0x00005555555a3035 <+53>:   jle    0x5555555a3040 <com.hello.Graal::main(java.lang.String[] *)+64>
   0x00005555555a303b <+59>:   add    $0x8,%rsp
   0x00005555555a303f <+63>:   ret    
   0x00005555555a3040 <+64>:   call   0x555555632530 <com.oracle.svm.core.thread.Safepoint::enterSlowPathSafepointCheck(void)>
   0x00005555555a3045 <+69>:   nop
   0x00005555555a3046 <+70>:   jmp    0x5555555a303b <com.hello.Graal::main(java.lang.String[] *)+59>
   0x00005555555a3048 <+72>:   call   0x5555555fffa0 <com.oracle.svm.core.graal.snippets.StackOverflowCheckImpl::throwNewStackOverflowError(void)>
```

Note that if you sent a breakpoint like this, it will not be hit!

```
(gdb) b 'com.hello.Graal::main'
Note: breakpoint 1 also set at pc 0x5555555a3000.
Breakpoint 2 at 0x5555555a3000: file com/hello/Graal.java, line 5.
(gdb) c
Continuing.
hello graal
```

That's because the `com.hello.Graal::main` function has been inlined into the `JavaMainWrapper_run_5087f5482cc9a6abc971913ece43acb471d2631b` function. `com.hello.Graal::main` exists just in case someone uses reflection to call it.

To understand how graal handles the two parameters to `java.io.PrintStream::writeln`, do this:

```
(gdb) b *0x55555569fe50
Breakpoint 4 at 0x55555569fe50: file java/io/PrintStream.java, line 718.
(gdb) c
Continuing.

Thread 1 "Hello" hit Breakpoint 4, java.io.PrintStream::writeln(java.lang.String *) (this=0x7ffff7a59e30, s=0x7ffff7788c98) at java/io/PrintStream.java:718
718	            synchronized (this) {
(gdb) x/11i $pc-47
   0x5555555af1fa <com.oracle.svm.core.JavaMainWrapper::runCore0(void)+202>:	add    %al,(%rax)
   0x5555555af1fc <com.oracle.svm.core.JavaMainWrapper::runCore0(void)+204>:	add    %al,(%rax)
   0x5555555af1fe <com.oracle.svm.core.JavaMainWrapper::runCore0(void)+206>:	lea    (%r14,%rdi,1),%rdi
   0x5555555af202 <com.oracle.svm.core.JavaMainWrapper::runCore0(void)+210>:	call   0x55555560db20 <com.oracle.svm.core.jdk.RuntimeSupport::initialize(void)>
   0x5555555af207 <com.oracle.svm.core.JavaMainWrapper::runCore0(void)+215>:	nop
   0x5555555af208 <com.oracle.svm.core.JavaMainWrapper::runCore0(void)+216>:	movabs $0x559e30,%rdi
   0x5555555af212 <com.oracle.svm.core.JavaMainWrapper::runCore0(void)+226>:	lea    (%r14,%rdi,1),%rdi
   0x5555555af216 <com.oracle.svm.core.JavaMainWrapper::runCore0(void)+230>:	movabs $0x288c98,%rsi
   0x5555555af220 <com.oracle.svm.core.JavaMainWrapper::runCore0(void)+240>:	lea    (%r14,%rsi,1),%rsi
   0x5555555af224 <com.oracle.svm.core.JavaMainWrapper::runCore0(void)+244>:	call   0x55555569fe50 <java.io.PrintStream::writeln(java.lang.String *)>
=> 0x5555555af229 <com.oracle.svm.core.JavaMainWrapper::runCore0(void)+249>:	nop
```

You can see the body of `com.hello.Graal::main` has been inlined at around `0x5555555af208`, and the two arguments for `writeln` are in `%rdi` (0x7ffff7a59e30) and `%rsi` (0x7ffff7788c98)

```
(gdb) print *('java.lang.String' *) 0x7ffff7788c98
$6 = {<java.lang.Object> = {
  <_objhdr> = {hub = 0x37b060, idHash = 923539816}, <No data fields>},
  hash = 1779402419, value = 0x1eadd0, coder = 0 '\000',  hashIsZero = false}

(gdb) p *('byte[]'*) ($r14 + 0x1eadd0)
$14 = {<java.lang.Object> = {
  <_objhdr> = {hub = 0x3af5f0, idHash = 886317720}, <No data fields>},
  len = 11, data = 0x7ffff76eade0 "hello graal"}
```

Here, `value = 0x1eadd0` is a compressed oop (`narrowOop`). From line 0x5555555af212, we can see that to convert a `narrowOop` to an `oop` is simply adding `%r14` (the narrowOop base). Because graal uses ASLR to dynamically relocate its heap for added security, we can't use zero-based narrowOop encoding.


## A more complex example -- how native-image handles indy string concat

Here we want to understand how native-image compiles invokedynamic bytecodes -- i.e., how does it converts a dynamic behavior into static x64 code.

- For more info about indy string concat, see (see [JEP 280: Indify String Concatenation](https://openjdk.org/jeps/280)).

Conveniently there's already a demo that has string concat:

- Get the demo from [native-hello-module](https://github.com/graalvm/graalvm-demos/tree/master/native-hello-module)
- Here's the source code [Main.java](https://github.com/graalvm/graalvm-demos/blob/master/native-hello-module/src/main/java/hello/Main.java)
- Follow the instructions to build and execute the `hellomodule` binary

Now, rebuild it with `-g` and load it in gdb.

You can see that native-image has effectively executed the bootstrap method `StringConcatFactory.makeConcatWithConstants()` at build time, and compiled the invokedynamic bytecode as an invocation of the target MethodHandle associated with the resolved CallSite.

- The target MethodHandle in turn calls other methods like `StringConcatHelper::mix`, `StringConcatHelper::prepend`, etc. (I will be writing about them in a separate note).
- All these calls are inlined into 

```
$ native-image -g --module-path target/HelloModule-1.0-SNAPSHOT.jar --module HelloModule
$ gdb ./hellomodule
(gdb) info func ::main
All functions matching regular expression "::main":

File hello/Main.java:
   void hello.Main::main(java.lang.String[] *);

(gdb) set height 0
(gdb) disass 'hello.Main::main'
Dump of assembler code for function hello.Main::main(java.lang.String[] *):
   0x000000000013d800 <+0>:     sub    $0x28,%rsp
   0x000000000013d804 <+4>:     cmp    0x8(%r15),%rsp
   0x000000000013d808 <+8>:     jbe    0x13d968 <hello.Main::main(java.lang.String[] *)+360>
   0x000000000013d80e <+14>:    movabs $0x28db10,%rax
   0x000000000013d818 <+24>:    lea    (%r14,%rax,1),%rax
   0x000000000013d81c <+28>:    movabs $0x55a4a8,%rcx
   0x000000000013d826 <+38>:    lea    (%r14,%rcx,1),%rcx
   0x000000000013d82a <+42>:    movabs $0x28db30,%rdx
   0x000000000013d834 <+52>:    lea    (%r14,%rdx,1),%rdx
   0x000000000013d838 <+56>:    mov    $0x0,%rdi
   0x000000000013d83f <+63>:    mov    %rax,%rsi
   0x000000000013d842 <+66>:    mov    %rcx,0x18(%rsp)
   0x000000000013d847 <+71>:    mov    %rax,0x10(%rsp)
   0x000000000013d84c <+76>:    mov    %rdx,0x8(%rsp)
   0x000000000013d851 <+81>:    call   0x18d860 <java.lang.StringConcatHelper::mix(long, java.lang.String *)>
   0x000000000013d856 <+86>:    nop
   0x000000000013d857 <+87>:    mov    %rax,%rdi
   0x000000000013d85a <+90>:    mov    0x8(%rsp),%rsi
   0x000000000013d85f <+95>:    call   0x18d860 <java.lang.StringConcatHelper::mix(long, java.lang.String *)>
   0x000000000013d864 <+100>:   nop
   0x000000000013d865 <+101>:   mov    %eax,%edi
   0x000000000013d867 <+103>:   mov    %rax,%rcx
   0x000000000013d86a <+106>:   sar    $0x20,%rcx
   0x000000000013d86e <+110>:   mov    %ecx,%ecx
   0x000000000013d870 <+112>:   movsbl %cl,%ecx
   0x000000000013d873 <+115>:   mov    %edi,%edx
   0x000000000013d875 <+117>:   shl    %cl,%edx
   0x000000000013d877 <+119>:   test   %edx,%edx
   0x000000000013d879 <+121>:   jl     0x13d96e <hello.Main::main(java.lang.String[] *)+366>
   0x000000000013d87f <+127>:   movabs $0x3af5f0,%rdi
   0x000000000013d889 <+137>:   lea    (%r14,%rdi,1),%rdi
   0x000000000013d88d <+141>:   mov    0x28(%r15),%rsi
   0x000000000013d891 <+145>:   mov    0x20(%r15),%rcx
   0x000000000013d895 <+149>:   sub    %r14,%rdi
   0x000000000013d898 <+152>:   mov    %edx,%ebx
   0x000000000013d89a <+154>:   lea    0x17(%rbx),%rbx
   0x000000000013d89e <+158>:   and    $0xfffffffffffffff8,%rbx
   0x000000000013d8a2 <+162>:   cmp    $0x20000,%rbx
   0x000000000013d8a9 <+169>:   jae    0x13d944 <hello.Main::main(java.lang.String[] *)+324>
   0x000000000013d8af <+175>:   mov    %rbx,%rbp
   0x000000000013d8b2 <+178>:   add    %rsi,%rbp
   0x000000000013d8b5 <+181>:   cmp    %rcx,%rbp
   0x000000000013d8b8 <+184>:   ja     0x13d944 <hello.Main::main(java.lang.String[] *)+324>
   0x000000000013d8be <+190>:   mov    %rbp,0x28(%r15)
   0x000000000013d8c2 <+194>:   prefetchnta 0xc0(%rbx,%rsi,1)
   0x000000000013d8ca <+202>:   prefetchnta 0x100(%rbx,%rsi,1)
   0x000000000013d8d2 <+210>:   prefetchnta 0x140(%rbx,%rsi,1)
   0x000000000013d8da <+218>:   prefetchnta 0x180(%rbx,%rsi,1)
   0x000000000013d8e2 <+226>:   mov    %edx,0xc(%rsi)
   0x000000000013d8e5 <+229>:   mov    %rdi,(%rsi)
   0x000000000013d8e8 <+232>:   movl   $0x0,0x8(%rsi)
   0x000000000013d8ef <+239>:   mov    %rax,%rdi
   0x000000000013d8f2 <+242>:   mov    %rsi,%rax
   0x000000000013d8f5 <+245>:   mov    0x8(%rsp),%rdx
   0x000000000013d8fa <+250>:   mov    %rax,0x8(%rsp)
   0x000000000013d8ff <+255>:   call   0x18df20 <java.lang.StringConcatHelper::prepend(long, byte [] *, java.lang.String *)>
   0x000000000013d904 <+260>:   nop
   0x000000000013d905 <+261>:   mov    %rax,%rdi
   0x000000000013d908 <+264>:   mov    0x8(%rsp),%rsi
   0x000000000013d90d <+269>:   mov    0x10(%rsp),%rdx
   0x000000000013d912 <+274>:   call   0x18df20 <java.lang.StringConcatHelper::prepend(long, byte [] *, java.lang.String *)>
   0x000000000013d917 <+279>:   nop
   0x000000000013d918 <+280>:   mov    0x8(%rsp),%rdi
   0x000000000013d91d <+285>:   mov    %rax,%rsi
   0x000000000013d920 <+288>:   call   0x18d8f0 <java.lang.StringConcatHelper::newString(byte [] *, long)>
   0x000000000013d925 <+293>:   nop
   0x000000000013d926 <+294>:   mov    0x18(%rsp),%rdi
   0x000000000013d92b <+299>:   mov    %rax,%rsi
   0x000000000013d92e <+302>:   call   0x14bf80 <java.io.PrintStream::writeln(java.lang.String *)>
   0x000000000013d933 <+307>:   nop
   0x000000000013d934 <+308>:   subl   $0x1,0x10(%r15)
   0x000000000013d939 <+313>:   jle    0x13d960 <hello.Main::main(java.lang.String[] *)+352>
   0x000000000013d93f <+319>:   add    $0x28,%rsp
   0x000000000013d943 <+323>:   ret    
   0x000000000013d944 <+324>:   mov    %rax,0x20(%rsp)
   0x000000000013d949 <+329>:   mov    %edx,%esi
   0x000000000013d94b <+331>:   mov    $0x10,%edx
   0x000000000013d950 <+336>:   call   0x9dd10 <com.oracle.svm.core.genscavenge.ThreadLocalAllocation::slowPathNewArray(org.graalvm.compiler.word.Word *, int, int)>
   0x000000000013d955 <+341>:   nop
   0x000000000013d956 <+342>:   mov    %rax,%rsi
   0x000000000013d959 <+345>:   mov    0x20(%rsp),%rax
   0x000000000013d95e <+350>:   jmp    0x13d8ef <hello.Main::main(java.lang.String[] *)+239>
   0x000000000013d960 <+352>:   call   0xde4d0 <com.oracle.svm.core.thread.Safepoint::enterSlowPathSafepointCheck(void)>
   0x000000000013d965 <+357>:   nop
   0x000000000013d966 <+358>:   jmp    0x13d93f <hello.Main::main(java.lang.String[] *)+319>
   0x000000000013d968 <+360>:   call   0xabf40 <com.oracle.svm.core.graal.snippets.StackOverflowCheckImpl::throwNewStackOverflowError(void)>
   0x000000000013d96d <+365>:   nop
   0x000000000013d96e <+366>:   movabs $0x2890b0,%rdi
   0x000000000013d978 <+376>:   lea    (%r14,%rdi,1),%rdi
   0x000000000013d97c <+380>:   call   0xd6f20 <com.oracle.svm.core.snippets.ImplicitExceptions::throwNewIllegalArgumentExceptionWithArgs(java.lang.String *)>
   0x000000000013d981 <+385>:   nop
End of assembler dump.
```

Just for fun, let's look at the `mix(long, java.lang.String *)` function, which computes the length+coder of a `String`.

```

    /**
     * Mix value length and coder into current length and coder.
     * @param lengthCoder String length with coder packed into higher bits
     *                    the upper word.
     * @param value       value to mix in
     * @return            new length and coder
     */
    static long mix(long lengthCoder, String value) {
        lengthCoder += value.length();
        if (value.coder() == String.UTF16) {
            lengthCoder |= UTF16;
        }
        return checkOverflow(lengthCoder);
    }

(gdb) disass 'java.lang.StringConcatHelper::mix(long, java.lang.String *)'
Dump of assembler code for function java.lang.StringConcatHelper::mix(long, java.lang.String *):
   0x000000000018d860 <+0>:    sub    $0x18,%rsp
   0x000000000018d864 <+4>:    cmp    0x8(%r15),%rsp
   0x000000000018d868 <+8>:    jbe    0x18d8d9 <java.lang.StringConcatHelper::mix(long, java.lang.String *)+121>
   0x000000000018d86e <+14>:   cmp    %r14,%rsi
   0x000000000018d871 <+17>:   je     0x18d8df <java.lang.StringConcatHelper::mix(long, java.lang.String *)+127>
   0x000000000018d877 <+23>:   mov    0x10(%rsi),%rcx
   0x000000000018d87b <+27>:   test   %rcx,%rcx
   0x000000000018d87e <+30>:   je     0x18d8e5 <java.lang.StringConcatHelper::mix(long, java.lang.String *)+133>
   0x000000000018d884 <+36>:   mov    0xc(%r14,%rcx,1),%eax
   0x000000000018d889 <+41>:   movsbl 0x18(%rsi),%edx
   0x000000000018d88d <+45>:   mov    %edx,%ecx
   0x000000000018d88f <+47>:   shr    %cl,%eax
   0x000000000018d891 <+49>:   mov    %eax,%eax
   0x000000000018d893 <+51>:   add    %rax,%rdi
   0x000000000018d896 <+54>:   cmp    $0x1,%edx
   0x000000000018d899 <+57>:   je     0x18d8c2 <java.lang.StringConcatHelper::mix(long, java.lang.String *)+98>
   0x000000000018d89f <+63>:   mov    %rdi,%rax
   0x000000000018d8a2 <+66>:   mov    %rax,0x10(%rsp)
   0x000000000018d8a7 <+71>:   call   0x18d340 <java.lang.StringConcatHelper::checkOverflow(long)>
   0x000000000018d8ac <+76>:   nop
   0x000000000018d8ad <+77>:   subl   $0x1,0x10(%r15)
   0x000000000018d8b2 <+82>:   jle    0x18d8d1 <java.lang.StringConcatHelper::mix(long, java.lang.String *)+113>
   0x000000000018d8b8 <+88>:   mov    0x10(%rsp),%rax
   0x000000000018d8bd <+93>:   add    $0x18,%rsp
   0x000000000018d8c1 <+97>:   ret    
   0x000000000018d8c2 <+98>:   movabs $0x100000000,%rax
   0x000000000018d8cc <+108>:  or     %rax,%rdi
   0x000000000018d8cf <+111>:  jmp    0x18d89f <java.lang.StringConcatHelper::mix(long, java.lang.String *)+63>
   0x000000000018d8d1 <+113>:  call   0xde4d0 <com.oracle.svm.core.thread.Safepoint::enterSlowPathSafepointCheck(void)>
   0x000000000018d8d6 <+118>:  nop
   0x000000000018d8d7 <+119>:  jmp    0x18d8b8 <java.lang.StringConcatHelper::mix(long, java.lang.String *)+88>
   0x000000000018d8d9 <+121>:  call   0xabf40 <com.oracle.svm.core.graal.snippets.StackOverflowCheckImpl::throwNewStackOverflowError(void)>
   0x000000000018d8de <+126>:  nop
   0x000000000018d8df <+127>:  call   0xd76e0 <com.oracle.svm.core.snippets.ImplicitExceptions::throwNewNullPointerException(void)>
   0x000000000018d8e4 <+132>:  nop
   0x000000000018d8e5 <+133>:  call   0xd76e0 <com.oracle.svm.core.snippets.ImplicitExceptions::throwNewNullPointerException(void)>
   0x000000000018d8ea <+138>:  nop
End of assembler dump.
(gdb) ptype 'java.lang.StringConcatHelper::mix(long, java.lang.String *)'
type = long (long, class java.lang.String *)
```
